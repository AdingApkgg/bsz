<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busuanzi Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --bg: #09090b; --card: #18181b; --border: #27272a; --text: #fafafa; --muted: #71717a; --accent: #3b82f6; --danger: #ef4444; --success: #22c55e; --warning: #f59e0b; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; min-height: 100vh; }
    .container { max-width: 1100px; margin: 0 auto; padding: 1.5rem 1rem; }
    
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.5rem; }
    .header h1 { font-size: 1.25rem; font-weight: 600; }
    .header-actions { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    
    .auth { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 2rem; max-width: 360px; margin: 6rem auto; }
    .auth h2 { margin-bottom: 1rem; font-size: 1.25rem; }
    .auth input { width: 100%; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); margin-bottom: 1rem; }
    .auth input:focus { outline: none; border-color: var(--accent); }
    
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    @media (max-width: 640px) { .stats { grid-template-columns: repeat(2, 1fr); } }
    .stat { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; }
    .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--accent); }
    .stat-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
    
    .toolbar { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
    .search { flex: 1; min-width: 200px; padding: 0.625rem 1rem; background: var(--card); border: 1px solid var(--border); border-radius: 6px; color: var(--text); }
    .search:focus { outline: none; border-color: var(--accent); }
    .search::placeholder { color: var(--muted); }
    .toolbar-right { display: flex; gap: 0.5rem; align-items: center; }
    .sort-select { padding: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem; }
    
    .table-wrap { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
    th { font-weight: 500; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; background: rgba(255,255,255,0.02); cursor: pointer; user-select: none; }
    th:hover { color: var(--text); }
    th.sorted { color: var(--accent); }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.02); }
    .hash { font-family: ui-monospace, monospace; font-size: 0.8rem; color: var(--muted); cursor: pointer; }
    .hash:hover { color: var(--text); }
    .num { font-variant-numeric: tabular-nums; }
    .actions { display: flex; gap: 0.25rem; }
    .empty { text-align: center; padding: 3rem; color: var(--muted); }
    
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem; cursor: pointer; transition: all 0.15s; display: inline-flex; align-items: center; gap: 0.375rem; }
    .btn:hover { opacity: 0.85; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: black; }
    .btn-ghost { background: transparent; color: var(--muted); padding: 0.375rem 0.625rem; }
    .btn-ghost:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
    
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); justify-content: center; align-items: center; z-index: 100; }
    .modal.show { display: flex; }
    .modal-content { background: var(--card); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 420px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 1rem; font-weight: 500; }
    .modal-body { padding: 1.25rem; }
    .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; justify-content: flex-end; }
    
    .form-group { margin-bottom: 1rem; }
    .form-group:last-child { margin-bottom: 0; }
    .form-group label { display: block; font-size: 0.875rem; color: var(--muted); margin-bottom: 0.375rem; }
    .form-group input, .form-group select { width: 100%; padding: 0.625rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
    .form-group input:read-only { opacity: 0.6; cursor: not-allowed; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .help { font-size: 0.75rem; color: var(--muted); margin-top: 0.25rem; }
    
    .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: var(--card); border: 1px solid var(--border); padding: 0.75rem 1.25rem; border-radius: 8px; display: none; z-index: 200; }
    .toast.show { display: block; animation: slideIn 0.2s; }
    .toast.error { border-color: var(--danger); color: var(--danger); }
    .toast.success { border-color: var(--success); color: var(--success); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .auto-refresh { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--muted); }
    .auto-refresh input { width: 16px; height: 16px; }
    
    .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-top: 1px solid var(--border); font-size: 0.75rem; color: var(--muted); }
    
    .hidden { display: none !important; }
    
    .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
  </style>
</head>
<body>
  <div id="auth" class="auth hidden">
    <h2>管理面板</h2>
    <input type="password" id="token-input" placeholder="输入 Admin Token" onkeydown="if(event.key==='Enter')login()">
    <button class="btn btn-primary" style="width:100%" onclick="login()">登录</button>
  </div>

  <div id="main" class="container hidden">
    <div class="header">
      <h1>Busuanzi Admin</h1>
      <div class="header-actions">
        <label class="auto-refresh">
          <input type="checkbox" id="auto-refresh" onchange="toggleAutoRefresh()">
          自动刷新
        </label>
        <button class="btn btn-primary" onclick="openSync()">同步</button>
        <button class="btn btn-ghost" onclick="openImport()">导入</button>
        <button class="btn btn-ghost" onclick="exportData()">导出</button>
        <button class="btn btn-ghost" onclick="init()">↻ 刷新</button>
        <button class="btn btn-ghost" onclick="logout()">登出</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="stat-sites">-</div>
        <div class="stat-label">站点</div>
                </div>
      <div class="stat">
        <div class="stat-value" id="stat-pages">-</div>
        <div class="stat-label">页面</div>
                </div>
      <div class="stat">
        <div class="stat-value" id="stat-pv">-</div>
                    <div class="stat-label">总 PV</div>
                </div>
      <div class="stat">
        <div class="stat-value" id="stat-uv">-</div>
                    <div class="stat-label">总 UV</div>
                </div>
            </div>

    <div class="toolbar">
      <input type="text" class="search" id="search" placeholder="搜索站点 Hash..." oninput="filterKeys()">
      <div class="toolbar-right">
        <select class="sort-select" id="sort" onchange="filterKeys()">
          <option value="pv-desc">PV 降序</option>
          <option value="pv-asc">PV 升序</option>
          <option value="uv-desc">UV 降序</option>
          <option value="uv-asc">UV 升序</option>
          <option value="hash-asc">Hash A-Z</option>
        </select>
      </div>
            </div>
            
    <div class="table-wrap">
      <table>
                <thead>
                    <tr>
            <th style="width:40%">站点</th>
            <th>PV</th>
            <th>UV</th>
            <th>页面</th>
            <th style="width:100px">操作</th>
                    </tr>
                </thead>
                <tbody id="keys-body">
          <tr><td colspan="5" class="empty">加载中...</td></tr>
                </tbody>
            </table>
      <div class="status-bar">
        <span id="status-count">-</span>
        <span id="status-time">-</span>
      </div>
    </div>
            </div>

  <div id="edit-modal" class="modal" onclick="if(event.target===this)closeModal('edit-modal')">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>编辑站点数据</h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('edit-modal')">✕</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>站点 Hash</label>
                        <input type="text" id="edit-hash" readonly>
                    </div>
        <div class="form-row">
                    <div class="form-group">
                        <label>Site PV</label>
            <input type="number" id="edit-pv" min="0">
                    </div>
                    <div class="form-group">
                        <label>Site UV</label>
            <input type="number" id="edit-uv" min="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('edit-modal')">取消</button>
                    <button class="btn btn-primary" onclick="saveEdit()">保存</button>
                </div>
            </div>
        </div>

  <div id="delete-modal" class="modal" onclick="if(event.target===this)closeModal('delete-modal')">
    <div class="modal-content">
                <div class="modal-header">
                    <h3>确认删除</h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('delete-modal')">✕</button>
                </div>
                <div class="modal-body">
        <p>确定删除 <code id="delete-hash" style="color:var(--accent)"></code> 的所有数据？</p>
        <p style="color:var(--danger);margin-top:0.75rem;font-size:0.875rem">⚠ 此操作不可恢复！</p>
                </div>
                <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('delete-modal')">取消</button>
                    <button class="btn btn-danger" onclick="confirmDelete()">删除</button>
                </div>
            </div>
  </div>

  <div id="pages-modal" class="modal" onclick="if(event.target===this)closeModal('pages-modal')">
    <div class="modal-content" style="max-width:700px">
      <div class="modal-header">
        <h3>页面列表 - <code id="pages-site-hash" style="font-size:0.8rem"></code></h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('pages-modal')">✕</button>
      </div>
      <div class="modal-body" style="padding:0;max-height:60vh;overflow-y:auto">
        <table style="width:100%">
          <thead>
            <tr>
              <th>路径</th>
              <th style="width:80px">PV</th>
              <th style="width:100px">操作</th>
            </tr>
          </thead>
          <tbody id="pages-body">
            <tr><td colspan="3" class="empty">加载中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="edit-page-modal" class="modal" onclick="if(event.target===this)closeModal('edit-page-modal')">
    <div class="modal-content">
      <div class="modal-header">
        <h3>编辑页面 PV</h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('edit-page-modal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Page Key</label>
          <input type="text" id="edit-page-key" readonly style="font-size:0.75rem">
        </div>
        <div class="form-group">
          <label>Page PV</label>
          <input type="number" id="edit-page-pv" min="0">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('edit-page-modal')">取消</button>
        <button class="btn btn-primary" onclick="savePageEdit()">保存</button>
      </div>
    </div>
  </div>

  <div id="import-modal" class="modal" onclick="if(event.target===this)closeModal('import-modal')">
    <div class="modal-content" style="max-width:560px">
      <div class="modal-header">
        <h3>导入数据</h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('import-modal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>选择 JSON 文件</label>
          <input type="file" id="import-file" accept=".json" style="padding:0.5rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;width:100%">
        </div>
        <div class="form-group">
          <label>或粘贴 JSON</label>
          <textarea id="import-json" rows="8" placeholder='{"sites":{"hash":{"pv":100,"uv":10}},"pages":{"hash:pagehash":{"pv":50}}}' style="width:100%;padding:0.625rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:monospace;font-size:0.8rem;resize:vertical"></textarea>
        </div>
        <p class="help">支持格式: <code>{"sites":{"hash":{"pv":N,"uv":N}},"pages":{"site:page":{"pv":N}}}</code></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('import-modal')">取消</button>
        <button class="btn btn-primary" onclick="doImport()">导入</button>
      </div>
    </div>
  </div>

  <div id="sync-modal" class="modal" onclick="if(event.target===this)closeModal('sync-modal')">
    <div class="modal-content">
      <div class="modal-header">
        <h3>从 Sitemap 同步</h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('sync-modal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group" style="flex:3">
            <label>Sitemap URL</label>
            <input type="url" id="sync-sitemap" placeholder="https://example.com/sitemap.xml">
          </div>
          <div class="form-group" style="flex:1">
            <label>并发数</label>
            <input type="number" id="sync-concurrency" value="3" min="1" max="10">
          </div>
        </div>
        <p class="help">从 sitemap.xml 获取所有页面 URL，并发从 busuanzi.ibruce.info 拉取 PV 数据。</p>
        <div id="sync-progress" class="hidden" style="margin-top:1rem">
          <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
          <div id="progress-stats" style="display:flex;gap:1rem;margin:0.5rem 0;font-size:0.75rem;color:var(--muted)">
            <span>进度: <b id="p-current">0</b>/<b id="p-total">0</b></span>
            <span>成功: <b id="p-imported" style="color:var(--success)">0</b></span>
            <span>失败: <b id="p-errors" style="color:var(--danger)">0</b></span>
          </div>
          <div id="progress-current" style="padding:0.5rem;background:var(--bg);border-radius:4px;font-size:0.8rem;font-family:monospace;max-height:120px;overflow-y:auto"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('sync-modal')">取消</button>
        <button class="btn btn-primary" id="sync-btn" onclick="doSync()">开始同步</button>
        </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const API = '/api/admin';
    let token = localStorage.getItem('admin-token') || '';
    let allKeys = [];
    let currentHash = '';
    let refreshInterval = null;

    const $ = id => document.getElementById(id);
    const fmt = n => n?.toLocaleString() ?? '-';
    const now = () => new Date().toLocaleTimeString();
    
    function headers() {
      return { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };
    }

    function toast(msg, type = 'success') {
      const el = $('toast');
      el.textContent = msg;
      el.className = 'toast show ' + type;
      setTimeout(() => el.className = 'toast', 2500);
    }

    function closeModal(id) {
      $(id).classList.remove('show');
    }

    function login() {
      token = $('token-input').value.trim();
      if (!token) return toast('请输入 Token', 'error');
      localStorage.setItem('admin-token', token);
      init();
    }

    function logout() {
      token = '';
      localStorage.removeItem('admin-token');
      $('auth').classList.remove('hidden');
      $('main').classList.add('hidden');
      $('token-input').value = '';
      if (refreshInterval) clearInterval(refreshInterval);
    }

    async function init() {
      try {
        const res = await fetch(API + '/stats', { headers: headers() });
        if (!res.ok) throw new Error('认证失败');
        const json = await res.json();
        if (!json.success) throw new Error('失败');
        const data = json.data || {};
        
        $('auth').classList.add('hidden');
        $('main').classList.remove('hidden');
        $('stat-sites').textContent = fmt(data.total_sites);
        $('stat-pages').textContent = fmt(data.total_pages);
        $('stat-pv').textContent = fmt(data.total_site_pv);
        $('stat-uv').textContent = fmt(data.total_site_uv);
        $('status-time').textContent = '更新于 ' + now();
        
        loadKeys();
      } catch (e) {
        $('auth').classList.remove('hidden');
        $('main').classList.add('hidden');
        if (token) toast('认证失败', 'error');
      }
    }

    async function loadKeys() {
      try {
        const res = await fetch(API + '/keys?count=500', { headers: headers() });
        const json = await res.json();
        allKeys = json.data || [];
        filterKeys();
      } catch (e) {
        toast('加载失败', 'error');
      }
    }

    function filterKeys() {
      const q = $('search').value.toLowerCase().trim();
      let filtered = q ? allKeys.filter(k => k.site_hash.toLowerCase().includes(q)) : [...allKeys];
      
      const sort = $('sort').value;
      filtered.sort((a, b) => {
        switch (sort) {
          case 'pv-desc': return (b.site_pv || 0) - (a.site_pv || 0);
          case 'pv-asc': return (a.site_pv || 0) - (b.site_pv || 0);
          case 'uv-desc': return (b.site_uv || 0) - (a.site_uv || 0);
          case 'uv-asc': return (a.site_uv || 0) - (b.site_uv || 0);
          case 'hash-asc': return a.site_hash.localeCompare(b.site_hash);
          default: return 0;
        }
      });
      
      renderKeys(filtered);
      $('status-count').textContent = `共 ${filtered.length} 个站点`;
    }

    function renderKeys(keys) {
      const tbody = $('keys-body');
      if (!keys.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">暂无数据</td></tr>';
        return;
      }
      tbody.innerHTML = keys.map(k => {
        const display = k.host || k.site_hash;
        const shortDisplay = display.length > 30 ? display.slice(0, 27) + '...' : display;
        return `
        <tr>
          <td class="hash" onclick="copyHash('${k.site_hash}')" title="${k.host || k.site_hash}&#10;Hash: ${k.site_hash}">${shortDisplay}</td>
          <td class="num">${fmt(k.site_pv)}</td>
          <td class="num">${fmt(k.site_uv)}</td>
          <td class="num"><a href="#" onclick="openPages('${k.site_hash}');return false" style="color:var(--accent)">${fmt(k.page_count)}</a></td>
          <td class="actions">
            <button class="btn btn-ghost btn-sm" onclick="openEdit('${k.site_hash}', ${k.site_pv || 0}, ${k.site_uv || 0})">编辑</button>
            <button class="btn btn-ghost btn-sm" style="color:var(--danger)" onclick="openDelete('${k.site_hash}')">删除</button>
          </td>
        </tr>
      `}).join('');
    }

    function copyHash(hash) {
      navigator.clipboard.writeText(hash);
      toast('已复制');
    }

    function openEdit(hash, pv, uv) {
      currentHash = hash;
      $('edit-hash').value = hash;
      $('edit-pv').value = pv;
      $('edit-uv').value = uv;
      $('edit-modal').classList.add('show');
      $('edit-pv').focus();
    }

    async function saveEdit() {
      const pv = parseInt($('edit-pv').value) || 0;
      const uv = parseInt($('edit-uv').value) || 0;
      try {
        // Save PV
        await fetch(API + '/keys/update', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify({ site_hash: currentHash, key_type: 'site_pv', value: pv })
        });
        // Save UV
        await fetch(API + '/keys/update', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify({ site_hash: currentHash, key_type: 'site_uv', value: uv })
        });
        toast('已保存');
        closeModal('edit-modal');
        init();
      } catch (e) {
        toast('保存失败', 'error');
      }
    }

    function openDelete(hash) {
      currentHash = hash;
      $('delete-hash').textContent = hash;
      $('delete-modal').classList.add('show');
    }

    async function confirmDelete() {
      try {
        let url = API + '/keys?site_hash=' + encodeURIComponent(currentHash);
        if (currentPageKey) {
          url += '&page_key=' + encodeURIComponent(currentPageKey);
        }
        const res = await fetch(url, {
          method: 'DELETE',
          headers: headers()
        });
        if (!res.ok) throw new Error();
        toast('已删除');
        closeModal('delete-modal');
        if (currentPageKey) {
          currentPageKey = '';
          openPages(currentHash); // Refresh pages list
        } else {
          init();
        }
      } catch (e) {
        toast('删除失败', 'error');
      }
    }

    // ==================== Pages Management ====================
    let currentPageKey = '';

    async function openPages(siteHash) {
      currentHash = siteHash;
      $('pages-site-hash').textContent = siteHash;
      $('pages-body').innerHTML = '<tr><td colspan="3" class="empty">加载中...</td></tr>';
      $('pages-modal').classList.add('show');

      try {
        const res = await fetch(API + '/pages?site_hash=' + encodeURIComponent(siteHash), { headers: headers() });
        const json = await res.json();
        const pages = json.data || [];
        
        if (!pages.length) {
          $('pages-body').innerHTML = '<tr><td colspan="3" class="empty">暂无页面数据</td></tr>';
          return;
        }

        $('pages-body').innerHTML = pages.map(p => {
          const display = p.path || p.page_hash;
          const shortDisplay = display.length > 40 ? display.slice(0, 37) + '...' : display;
          const safeDisplay = shortDisplay.replace(/'/g, "\\'");
          return `
          <tr>
            <td class="hash" onclick="copyHash('${p.path || p.page_hash}')" title="${p.path || ''}&#10;Hash: ${p.page_hash}">${shortDisplay}</td>
            <td class="num">${fmt(p.pv)}</td>
            <td class="actions">
              <button class="btn btn-ghost btn-sm" onclick="openPageEdit('${p.page_key}', ${p.pv})">编辑</button>
              <button class="btn btn-ghost btn-sm" style="color:var(--danger)" onclick="openPageDelete('${p.page_key}', '${safeDisplay}')">删除</button>
            </td>
          </tr>
        `}).join('');
      } catch (e) {
        $('pages-body').innerHTML = '<tr><td colspan="3" class="empty">加载失败</td></tr>';
      }
    }

    function openPageEdit(pageKey, pv) {
      currentPageKey = pageKey;
      $('edit-page-key').value = pageKey;
      $('edit-page-pv').value = pv;
      $('edit-page-modal').classList.add('show');
      $('edit-page-pv').focus();
    }

    async function savePageEdit() {
      const pv = parseInt($('edit-page-pv').value) || 0;
      try {
        const res = await fetch(API + '/pages/update', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify({ page_key: currentPageKey, pv })
        });
        if (!res.ok) throw new Error();
        toast('已保存');
        closeModal('edit-page-modal');
        openPages(currentHash); // Refresh
      } catch (e) {
        toast('保存失败', 'error');
      }
    }

    function openPageDelete(pageKey, pageHash) {
      currentPageKey = pageKey;
      $('delete-hash').textContent = '页面 ' + pageHash;
      $('delete-modal').classList.add('show');
    }

    function exportData() {
      const data = {
        exported_at: new Date().toISOString(),
        sites: allKeys
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `busuanzi-export-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      toast('已导出');
    }

    function toggleAutoRefresh() {
      if ($('auto-refresh').checked) {
        refreshInterval = setInterval(init, 10000);
        toast('已开启自动刷新 (10s)');
      } else {
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = null;
        toast('已关闭自动刷新');
      }
    }

    function openImport() {
      $('import-file').value = '';
      $('import-json').value = '';
      $('import-modal').classList.add('show');
    }

    async function doImport() {
      let data;
      const file = $('import-file').files[0];
      const json = $('import-json').value.trim();

      try {
        if (file) {
          const text = await file.text();
          data = JSON.parse(text);
        } else if (json) {
          data = JSON.parse(json);
        } else {
          return toast('请选择文件或粘贴 JSON', 'error');
        }
      } catch (e) {
        return toast('JSON 解析失败: ' + e.message, 'error');
      }

      // Normalize data format
      const importData = { sites: {}, pages: {} };
      
      if (data.sites) {
        for (const [key, val] of Object.entries(data.sites)) {
          if (typeof val === 'object') {
            importData.sites[key] = { pv: val.pv || val.site_pv || 0, uv: val.uv || val.site_uv };
          } else {
            importData.sites[key] = { pv: val, uv: 0 };
          }
        }
      }
      
      if (data.pages) {
        for (const [key, val] of Object.entries(data.pages)) {
          if (typeof val === 'object') {
            importData.pages[key] = { pv: val.pv || val.page_pv || 0 };
          } else {
            importData.pages[key] = { pv: val };
          }
        }
      }

      try {
        const res = await fetch(API + '/import', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify(importData)
        });
        const result = await res.json();
        if (!result.success) throw new Error(result.message);
        toast(result.message);
        closeModal('import-modal');
        init();
      } catch (e) {
        toast('导入失败: ' + e.message, 'error');
      }
    }

    function openSync() {
      $('sync-sitemap').value = '';
      $('sync-progress').classList.add('hidden');
      $('sync-btn').disabled = false;
      $('sync-modal').classList.add('show');
      $('sync-sitemap').focus();
    }

    let syncEventSource = null;

    function doSync() {
      const sitemap = $('sync-sitemap').value.trim();
      if (!sitemap) return toast('请输入 Sitemap URL', 'error');

      const concurrency = parseInt($('sync-concurrency').value) || 10;
      const btn = $('sync-btn');
      const progress = $('sync-progress');
      const currentLog = $('progress-current');
      
      btn.disabled = true;
      btn.textContent = '同步中...';
      progress.classList.remove('hidden');
      currentLog.innerHTML = `<div style="color:var(--muted)">正在获取 sitemap (并发: ${concurrency})...</div>`;

      // Close any existing connection
      if (syncEventSource) syncEventSource.close();

      // Use EventSource for SSE with concurrency param
      const url = `${API}/sync?sitemap_url=${encodeURIComponent(sitemap)}&concurrency=${concurrency}&token=${encodeURIComponent(token)}`;
      syncEventSource = new EventSource(url);

      syncEventSource.addEventListener('progress', (e) => {
        const d = JSON.parse(e.data);
        
        // Update stats
        if (d.total) {
          $('p-total').textContent = d.total;
          $('p-current').textContent = d.current || 0;
          $('p-imported').textContent = d.imported || 0;
          $('p-errors').textContent = d.errors || 0;
          
          const pct = Math.round((d.current / d.total) * 100);
          $('progress-fill').style.width = pct + '%';
        }
        
        // Update current item log
        if (d.path) {
          let line;
          if (d.error) {
            line = `<div style="color:var(--danger)">✗ ${d.path}</div>`;
          } else {
            line = `<div><span style="color:var(--success)">✓</span> ${d.path} <span style="color:var(--muted)">PV:${d.page_pv}</span></div>`;
          }
          currentLog.innerHTML = line + currentLog.innerHTML;
          // Keep only last 20 lines
          const lines = currentLog.children;
          while (lines.length > 20) lines[lines.length - 1].remove();
        } else if (d.message) {
          currentLog.innerHTML = `<div style="color:var(--muted)">${d.message}</div>` + currentLog.innerHTML;
        }
      });

      syncEventSource.addEventListener('error', (e) => {
        let msg = '同步失败';
        try { msg = JSON.parse(e.data).message; } catch {}
        currentLog.innerHTML = `<div style="color:var(--danger)">${msg}</div>` + currentLog.innerHTML;
        btn.disabled = false;
        btn.textContent = '重试';
        syncEventSource.close();
      });

      syncEventSource.addEventListener('complete', (e) => {
        const data = JSON.parse(e.data);
        currentLog.innerHTML = `<div style="color:var(--success);font-weight:500">${data.message}</div>` + currentLog.innerHTML;
        $('progress-fill').style.width = '100%';
        toast(data.message);
        syncEventSource.close();
        btn.disabled = false;
        btn.textContent = '完成';
        setTimeout(() => init(), 1000);
      });

      syncEventSource.onerror = () => {
        currentLog.innerHTML = `<div style="color:var(--danger)">连接断开</div>` + currentLog.innerHTML;
        btn.disabled = false;
        btn.textContent = '重试';
        syncEventSource.close();
      };
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeModal('edit-modal');
        closeModal('delete-modal');
        closeModal('import-modal');
        closeModal('sync-modal');
        closeModal('pages-modal');
        closeModal('edit-page-modal');
      }
    });

    if (token) init();
    else $('auth').classList.remove('hidden');
  </script>
</body>
</html>
