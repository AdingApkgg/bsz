<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busuanzi Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --bg: #09090b; --card: #18181b; --border: #27272a; --text: #fafafa; --muted: #71717a; --accent: #3b82f6; --danger: #ef4444; --success: #22c55e; --warning: #f59e0b; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; min-height: 100vh; }
    .container { max-width: 1100px; margin: 0 auto; padding: 1.5rem 1rem; }
    
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.5rem; }
    .header h1 { font-size: 1.25rem; font-weight: 600; }
    .header-actions { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    
    .auth { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 2rem; max-width: 360px; margin: 6rem auto; }
    .auth h2 { margin-bottom: 1rem; font-size: 1.25rem; }
    .auth input { width: 100%; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); margin-bottom: 1rem; }
    .auth input:focus { outline: none; border-color: var(--accent); }
    
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    @media (max-width: 768px) { .stats { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 480px) { .stats { grid-template-columns: 1fr; } }
    .stat { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; }
    .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--accent); }
    .stat-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
    
    .toolbar { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
    .search { flex: 1; min-width: 200px; padding: 0.625rem 1rem; background: var(--card); border: 1px solid var(--border); border-radius: 6px; color: var(--text); }
    .search:focus { outline: none; border-color: var(--accent); }
    .search::placeholder { color: var(--muted); }
    .toolbar-right { display: flex; gap: 0.5rem; align-items: center; }
    .sort-select { padding: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem; }
    
    .table-wrap { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
    th { font-weight: 500; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; background: rgba(255,255,255,0.02); cursor: pointer; user-select: none; }
    th:hover { color: var(--text); }
    th.sorted { color: var(--accent); }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.02); }
    .hash { font-family: ui-monospace, monospace; font-size: 0.8rem; color: var(--muted); cursor: pointer; }
    .hash:hover { color: var(--text); }
    .num { font-variant-numeric: tabular-nums; }
    .actions { display: flex; gap: 0.25rem; flex-wrap: wrap; }
    .empty { text-align: center; padding: 3rem; color: var(--muted); }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .table-wrap { overflow-x: auto; }
      table { min-width: 600px; }
      th, td { padding: 0.5rem 0.75rem; font-size: 0.8rem; }
      .btn-sm { padding: 0.2rem 0.4rem; font-size: 0.7rem; }
      .header h1 { font-size: 1.1rem; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .search { min-width: auto; }
      .toolbar-right { justify-content: space-between; }
    }
    @media (max-width: 480px) {
      .container { padding: 1rem 0.75rem; }
      .stat { padding: 0.75rem; }
      .stat-value { font-size: 1.25rem; }
      .modal-content { width: 95%; margin: 0.5rem; }
      .modal-body { padding: 1rem; }
      .form-row { grid-template-columns: 1fr; }
      .toast { left: 1rem; right: 1rem; bottom: 1rem; }
    }
    
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem; cursor: pointer; transition: all 0.15s; display: inline-flex; align-items: center; gap: 0.375rem; }
    .btn:hover { opacity: 0.85; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: black; }
    .btn-ghost { background: transparent; color: var(--muted); padding: 0.375rem 0.625rem; }
    .btn-ghost:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
    
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); justify-content: center; align-items: center; z-index: 100; }
    .modal.show { display: flex; }
    .modal.modal-top { z-index: 150; }
    .modal-content { background: var(--card); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 420px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 1rem; font-weight: 500; }
    .modal-body { padding: 1.25rem; }
    .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; justify-content: flex-end; }
    
    .form-group { margin-bottom: 1rem; }
    .form-group:last-child { margin-bottom: 0; }
    .form-group label { display: block; font-size: 0.875rem; color: var(--muted); margin-bottom: 0.375rem; }
    .form-group input, .form-group select { width: 100%; padding: 0.625rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
    .form-group input:read-only { opacity: 0.6; cursor: not-allowed; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .help { font-size: 0.75rem; color: var(--muted); margin-top: 0.25rem; }
    
    .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: var(--card); border: 1px solid var(--border); padding: 0.75rem 1.25rem; border-radius: 8px; display: none; z-index: 200; }
    .toast.show { display: block; animation: slideIn 0.2s; }
    .toast.error { border-color: var(--danger); color: var(--danger); }
    .toast.success { border-color: var(--success); color: var(--success); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    
    .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-top: 1px solid var(--border); font-size: 0.75rem; color: var(--muted); }
    
    .hidden { display: none !important; }
    
    .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
  </style>
</head>
<body>
  <div id="auth" class="auth hidden">
    <h2>管理面板</h2>
    <input type="password" id="token-input" placeholder="输入 Admin Token" onkeydown="if(event.key==='Enter')login()">
    <button class="btn btn-primary" style="width:100%" onclick="login()">登录</button>
  </div>

  <div id="main" class="container hidden">
    <div class="header">
      <h1>Busuanzi Admin</h1>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openImport()">导入</button>
        <button class="btn btn-ghost" onclick="exportData()">导出</button>
        <button class="btn btn-ghost" onclick="logout()">登出</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="stat-sites">-</div>
        <div class="stat-label">站点</div>
                </div>
      <div class="stat">
        <div class="stat-value" id="stat-pages">-</div>
        <div class="stat-label">页面</div>
                </div>
      <div class="stat">
        <div class="stat-value" id="stat-pv">-</div>
                    <div class="stat-label">总 PV</div>
                </div>
      <div class="stat">
        <div class="stat-value" id="stat-uv">-</div>
                    <div class="stat-label">总 UV</div>
                </div>
            </div>

    <div class="toolbar">
      <input type="text" class="search" id="search" placeholder="搜索站点域名..." oninput="filterKeys()">
      <div class="toolbar-right">
        <select class="sort-select" id="sort" onchange="filterKeys()">
          <option value="pv-desc">PV 降序</option>
          <option value="pv-asc">PV 升序</option>
          <option value="uv-desc">UV 降序</option>
          <option value="uv-asc">UV 升序</option>
          <option value="key-asc">域名 A-Z</option>
        </select>
      </div>
            </div>
            
    <div class="table-wrap">
      <table>
                <thead>
                    <tr>
            <th style="width:30%">域名</th>
            <th>PV</th>
            <th>UV</th>
            <th>页面</th>
            <th style="width:200px">操作</th>
                    </tr>
                </thead>
                <tbody id="keys-body">
          <tr><td colspan="5" class="empty">加载中...</td></tr>
                </tbody>
            </table>
      <div class="status-bar">
        <span id="status-count">-</span>
        <span id="status-time">-</span>
      </div>
    </div>
            </div>

  <div id="edit-modal" class="modal" onclick="if(event.target===this)closeModal('edit-modal')">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>编辑站点数据</h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('edit-modal')">✕</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>站点域名</label>
                        <input type="text" id="edit-key" readonly>
                    </div>
        <div class="form-row">
                    <div class="form-group">
                        <label>Site PV</label>
            <input type="number" id="edit-pv" min="0">
                    </div>
                    <div class="form-group">
                        <label>Site UV</label>
            <input type="number" id="edit-uv" min="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('edit-modal')">取消</button>
                    <button class="btn btn-primary" onclick="saveEdit()">保存</button>
                </div>
            </div>
        </div>

  <div id="rename-modal" class="modal" onclick="if(event.target===this)closeModal('rename-modal')">
    <div class="modal-content">
      <div class="modal-header">
        <h3>重命名站点</h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('rename-modal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>原域名</label>
          <input type="text" id="rename-old" readonly>
        </div>
        <div class="form-group">
          <label>新域名</label>
          <input type="text" id="rename-new" placeholder="example.com">
        </div>
        <p class="help">用于网站更换域名后保留统计数据</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('rename-modal')">取消</button>
        <button class="btn btn-primary" onclick="confirmRename()">重命名</button>
      </div>
    </div>
  </div>

  <div id="merge-modal" class="modal" onclick="if(event.target===this)closeModal('merge-modal')">
    <div class="modal-content">
      <div class="modal-header">
        <h3>合并站点数据</h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('merge-modal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>源站点（将被删除）</label>
          <input type="text" id="merge-source" readonly>
        </div>
        <div class="form-group">
          <label>目标站点（保留）</label>
          <input type="text" id="merge-target" placeholder="example.com">
        </div>
        <p class="help">将源站点的 PV 累加到目标站点，UV 取较大值，页面数据合并</p>
        <p class="help" style="color:var(--warning);margin-top:0.5rem">⚠ 合并后源站点将被删除！</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('merge-modal')">取消</button>
        <button class="btn btn-warning" onclick="confirmMerge()">合并</button>
      </div>
    </div>
  </div>

  <div id="delete-modal" class="modal modal-top" onclick="if(event.target===this)closeModal('delete-modal')">
    <div class="modal-content">
                <div class="modal-header">
                    <h3>确认删除</h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('delete-modal')">✕</button>
                </div>
                <div class="modal-body">
        <p>确定删除 <code id="delete-key" style="color:var(--accent)"></code> 的所有数据？</p>
        <p style="color:var(--danger);margin-top:0.75rem;font-size:0.875rem">⚠ 此操作不可恢复！</p>
                </div>
                <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('delete-modal')">取消</button>
                    <button class="btn btn-danger" onclick="confirmDelete()">删除</button>
                </div>
            </div>
  </div>

  <div id="pages-modal" class="modal" onclick="if(event.target===this)closeModal('pages-modal')">
    <div class="modal-content" style="max-width:700px">
      <div class="modal-header">
        <h3>页面列表 - <code id="pages-site-key" style="font-size:0.8rem"></code></h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('pages-modal')">✕</button>
      </div>
      <div class="modal-body" style="padding:0;max-height:60vh;overflow-y:auto">
        <table style="width:100%">
          <thead>
            <tr>
              <th>路径</th>
              <th style="width:80px">PV</th>
              <th style="width:100px">操作</th>
            </tr>
          </thead>
          <tbody id="pages-body">
            <tr><td colspan="3" class="empty">加载中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="edit-page-modal" class="modal modal-top" onclick="if(event.target===this)closeModal('edit-page-modal')">
    <div class="modal-content">
      <div class="modal-header">
        <h3>编辑页面 PV</h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('edit-page-modal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Page Key</label>
          <input type="text" id="edit-page-key" readonly style="font-size:0.75rem">
        </div>
        <div class="form-group">
          <label>Page PV</label>
          <input type="number" id="edit-page-pv" min="0">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('edit-page-modal')">取消</button>
        <button class="btn btn-primary" onclick="savePageEdit()">保存</button>
      </div>
    </div>
  </div>

  <div id="import-modal" class="modal" onclick="if(event.target===this)closeModal('import-modal')">
    <div class="modal-content" style="max-width:480px">
      <div class="modal-header">
        <h3>导入数据</h3>
        <button class="btn btn-ghost btn-sm" onclick="closeModal('import-modal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="import-tabs" style="display:flex;gap:0.5rem;margin-bottom:1rem">
          <button class="btn btn-primary" id="tab-db" onclick="switchImportTab('db')">数据库</button>
          <button class="btn btn-ghost" id="tab-sync" onclick="switchImportTab('sync')">Sitemap 同步</button>
        </div>
        
        <div id="import-db-panel">
          <div class="form-group">
            <label>选择 data.db 文件</label>
            <input type="file" id="import-file" accept=".db" style="padding:0.5rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;width:100%">
          </div>
          <p class="help">上传从导出功能下载的 SQLite 数据库文件</p>
          <p class="help" style="color:var(--warning);margin-top:0.5rem">⚠ 导入将覆盖现有数据！</p>
        </div>
        
        <div id="import-sync-panel" class="hidden">
          <div class="form-group">
            <label>Sitemap URL</label>
            <input type="url" id="sync-sitemap" placeholder="https://example.com/sitemap.xml">
          </div>
          <div class="form-group">
            <label>或上传 XML 文件</label>
            <input type="file" id="sync-file" accept=".xml" style="padding:0.5rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;width:100%">
          </div>
          <div class="form-group">
            <label>并发数</label>
            <input type="number" id="sync-concurrency" value="3" min="1" max="10" style="width:80px">
          </div>
          <p class="help">从 sitemap.xml 获取 URL，从 busuanzi.ibruce.info 拉取数据</p>
          <div id="sync-progress" class="hidden" style="margin-top:1rem">
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            <div id="progress-stats" style="display:flex;gap:1rem;margin:0.5rem 0;font-size:0.75rem;color:var(--muted)">
              <span>进度: <b id="p-current">0</b>/<b id="p-total">0</b></span>
              <span>成功: <b id="p-imported" style="color:var(--success)">0</b></span>
              <span>失败: <b id="p-errors" style="color:var(--danger)">0</b></span>
            </div>
            <div id="progress-current" style="padding:0.5rem;background:var(--bg);border-radius:4px;font-size:0.8rem;font-family:monospace;max-height:120px;overflow-y:auto"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('import-modal')">取消</button>
        <button class="btn btn-primary" id="import-btn" onclick="doImportAction()">导入</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const API = '/api/admin';
    let token = localStorage.getItem('admin-token') || '';
    let allKeys = [];
    let currentSiteKey = '';

    const $ = id => document.getElementById(id);
    const fmt = n => n?.toLocaleString() ?? '-';
    const now = () => new Date().toLocaleTimeString();
    
    function headers() {
      return { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };
    }

    function toast(msg, type = 'success') {
      const el = $('toast');
      el.textContent = msg;
      el.className = 'toast show ' + type;
      setTimeout(() => el.className = 'toast', 2500);
    }

    function closeModal(id) {
      $(id).classList.remove('show');
    }

    function login() {
      token = $('token-input').value.trim();
      if (!token) return toast('请输入 Token', 'error');
      localStorage.setItem('admin-token', token);
      init();
    }

    function logout() {
      token = '';
      localStorage.removeItem('admin-token');
      $('auth').classList.remove('hidden');
      $('main').classList.add('hidden');
      $('token-input').value = '';
    }

    async function init() {
      try {
        const res = await fetch(API + '/stats', { headers: headers() });
        if (!res.ok) throw new Error('认证失败');
        const json = await res.json();
        if (!json.success) throw new Error('失败');
        const data = json.data || {};
        
        $('auth').classList.add('hidden');
        $('main').classList.remove('hidden');
        $('stat-sites').textContent = fmt(data.total_sites);
        $('stat-pages').textContent = fmt(data.total_pages);
        $('stat-pv').textContent = fmt(data.total_site_pv);
        $('stat-uv').textContent = fmt(data.total_site_uv);
        $('status-time').textContent = '更新于 ' + now();
        
        loadKeys();
      } catch (e) {
        $('auth').classList.remove('hidden');
        $('main').classList.add('hidden');
        if (token) toast('认证失败', 'error');
      }
    }

    async function loadKeys() {
      try {
        const res = await fetch(API + '/keys?count=500', { headers: headers() });
        const json = await res.json();
        allKeys = json.data || [];
        filterKeys();
      } catch (e) {
        toast('加载失败', 'error');
      }
    }

    function filterKeys() {
      const q = $('search').value.toLowerCase().trim();
      let filtered = q ? allKeys.filter(k => k.site_key.toLowerCase().includes(q)) : [...allKeys];
      
      const sort = $('sort').value;
      filtered.sort((a, b) => {
        switch (sort) {
          case 'pv-desc': return (b.site_pv || 0) - (a.site_pv || 0);
          case 'pv-asc': return (a.site_pv || 0) - (b.site_pv || 0);
          case 'uv-desc': return (b.site_uv || 0) - (a.site_uv || 0);
          case 'uv-asc': return (a.site_uv || 0) - (b.site_uv || 0);
          case 'key-asc': return a.site_key.localeCompare(b.site_key);
          default: return 0;
        }
      });
      
      renderKeys(filtered);
      $('status-count').textContent = `共 ${filtered.length} 个站点`;
    }

    function renderKeys(keys) {
      const tbody = $('keys-body');
      if (!keys.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">暂无数据</td></tr>';
        return;
      }
      tbody.innerHTML = keys.map(k => {
        const display = k.site_key;
        const shortDisplay = display.length > 30 ? display.slice(0, 27) + '...' : display;
        const safeKey = k.site_key.replace(/'/g, "\\'");
        return `
        <tr>
          <td class="hash" onclick="copyText('${safeKey}')" title="${k.site_key}">${shortDisplay}</td>
          <td class="num">${fmt(k.site_pv)}</td>
          <td class="num">${fmt(k.site_uv)}</td>
          <td class="num"><a href="#" onclick="openPages('${safeKey}');return false" style="color:var(--accent)">${fmt(k.page_count)}</a></td>
          <td class="actions">
            <button class="btn btn-ghost btn-sm" onclick="openEdit('${safeKey}', ${k.site_pv || 0}, ${k.site_uv || 0})">编辑</button>
            <button class="btn btn-ghost btn-sm" onclick="openRename('${safeKey}')">重命名</button>
            <button class="btn btn-ghost btn-sm" onclick="openMerge('${safeKey}')">合并</button>
            <button class="btn btn-ghost btn-sm" style="color:var(--danger)" onclick="openDelete('${safeKey}')">删除</button>
          </td>
        </tr>
      `}).join('');
    }

    function copyText(text) {
      navigator.clipboard.writeText(text);
      toast('已复制');
    }

    function openEdit(siteKey, pv, uv) {
      currentSiteKey = siteKey;
      $('edit-key').value = siteKey;
      $('edit-pv').value = pv;
      $('edit-uv').value = uv;
      $('edit-modal').classList.add('show');
      $('edit-pv').focus();
    }

    async function saveEdit() {
      const pv = parseInt($('edit-pv').value) || 0;
      const uv = parseInt($('edit-uv').value) || 0;
      try {
        // Save PV
        await fetch(API + '/keys/update', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify({ site_key: currentSiteKey, key_type: 'site_pv', value: pv })
        });
        // Save UV
        await fetch(API + '/keys/update', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify({ site_key: currentSiteKey, key_type: 'site_uv', value: uv })
        });
        toast('已保存');
        closeModal('edit-modal');
        init();
      } catch (e) {
        toast('保存失败', 'error');
      }
    }

    function openDelete(siteKey) {
      currentSiteKey = siteKey;
      $('delete-key').textContent = siteKey;
      $('delete-modal').classList.add('show');
    }

    function openRename(siteKey) {
      currentSiteKey = siteKey;
      $('rename-old').value = siteKey;
      $('rename-new').value = '';
      $('rename-modal').classList.add('show');
      $('rename-new').focus();
    }

    async function confirmRename() {
      const newKey = $('rename-new').value.trim();
      if (!newKey) return toast('请输入新域名', 'error');
      
      try {
        const res = await fetch(API + '/keys/rename', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify({ old_key: currentSiteKey, new_key: newKey })
        });
        const result = await res.json();
        if (!result.success) throw new Error(result.message);
        toast(result.message);
        closeModal('rename-modal');
        init();
      } catch (e) {
        toast(e.message || '重命名失败', 'error');
      }
    }

    function openMerge(siteKey) {
      currentSiteKey = siteKey;
      $('merge-source').value = siteKey;
      $('merge-target').value = '';
      $('merge-modal').classList.add('show');
      $('merge-target').focus();
    }

    async function confirmMerge() {
      const targetKey = $('merge-target').value.trim();
      if (!targetKey) return toast('请输入目标站点', 'error');
      
      try {
        const res = await fetch(API + '/keys/merge', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify({ source_key: currentSiteKey, target_key: targetKey })
        });
        const result = await res.json();
        if (!result.success) throw new Error(result.message);
        toast(result.message);
        closeModal('merge-modal');
        init();
      } catch (e) {
        toast(e.message || '合并失败', 'error');
      }
    }

    async function confirmDelete() {
      try {
        let url = API + '/keys?site_key=' + encodeURIComponent(currentSiteKey);
        if (currentPageKey) {
          url += '&page_key=' + encodeURIComponent(currentPageKey);
        }
        const res = await fetch(url, {
          method: 'DELETE',
          headers: headers()
        });
        if (!res.ok) throw new Error();
        toast('已删除');
        closeModal('delete-modal');
        if (currentPageKey) {
          currentPageKey = '';
          openPages(currentSiteKey); // Refresh pages list
        } else {
          init();
        }
      } catch (e) {
        toast('删除失败', 'error');
      }
    }

    // ==================== Pages Management ====================
    let currentPageKey = '';

    async function openPages(siteKey) {
      currentSiteKey = siteKey;
      $('pages-site-key').textContent = siteKey;
      $('pages-body').innerHTML = '<tr><td colspan="3" class="empty">加载中...</td></tr>';
      $('pages-modal').classList.add('show');

      try {
        const res = await fetch(API + '/pages?site_key=' + encodeURIComponent(siteKey), { headers: headers() });
        const json = await res.json();
        const pages = json.data || [];
        
        if (!pages.length) {
          $('pages-body').innerHTML = '<tr><td colspan="3" class="empty">暂无页面数据</td></tr>';
          return;
        }

        $('pages-body').innerHTML = pages.map(p => {
          const display = p.path;
          const shortDisplay = display.length > 40 ? display.slice(0, 37) + '...' : display;
          const safePageKey = p.page_key.replace(/'/g, "\\'");
          const safePath = p.path.replace(/'/g, "\\'");
          return `
          <tr>
            <td class="hash" onclick="copyText('${safePath}')" title="${p.path}">${shortDisplay}</td>
            <td class="num">${fmt(p.pv)}</td>
            <td class="actions">
              <button class="btn btn-ghost btn-sm" onclick="openPageEdit('${safePageKey}', ${p.pv})">编辑</button>
              <button class="btn btn-ghost btn-sm" style="color:var(--danger)" onclick="openPageDelete('${safePageKey}', '${shortDisplay.replace(/'/g, "\\'")}')">删除</button>
            </td>
          </tr>
        `}).join('');
      } catch (e) {
        $('pages-body').innerHTML = '<tr><td colspan="3" class="empty">加载失败</td></tr>';
      }
    }

    function openPageEdit(pageKey, pv) {
      currentPageKey = pageKey;
      $('edit-page-key').value = pageKey;
      $('edit-page-pv').value = pv;
      $('edit-page-modal').classList.add('show');
      $('edit-page-pv').focus();
    }

    async function savePageEdit() {
      const pv = parseInt($('edit-page-pv').value) || 0;
      try {
        const res = await fetch(API + '/pages/update', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify({ page_key: currentPageKey, pv })
        });
        if (!res.ok) throw new Error();
        toast('已保存');
        closeModal('edit-page-modal');
        openPages(currentSiteKey); // Refresh
      } catch (e) {
        toast('保存失败', 'error');
      }
    }

    function openPageDelete(pageKey, pagePath) {
      currentPageKey = pageKey;
      $('delete-key').textContent = '页面 ' + pagePath;
      $('delete-modal').classList.add('show');
    }

    function exportData() {
      const link = document.createElement('a');
      link.href = API + '/export?token=' + encodeURIComponent(token);
      link.click();
      toast('开始下载 data.db');
    }

    // ==================== Import ====================
    let currentImportTab = 'db';
    let syncEventSource = null;

    function switchImportTab(tab) {
      currentImportTab = tab;
      $('tab-db').className = tab === 'db' ? 'btn btn-primary' : 'btn btn-ghost';
      $('tab-sync').className = tab === 'sync' ? 'btn btn-primary' : 'btn btn-ghost';
      $('import-db-panel').classList.toggle('hidden', tab !== 'db');
      $('import-sync-panel').classList.toggle('hidden', tab !== 'sync');
      $('import-btn').textContent = tab === 'db' ? '导入' : '开始同步';
    }

    function openImport() {
      $('import-file').value = '';
      $('sync-sitemap').value = '';
      $('sync-file').value = '';
      $('sync-progress').classList.add('hidden');
      $('import-btn').disabled = false;
      switchImportTab('db');
      $('import-modal').classList.add('show');
    }

    async function doImportAction() {
      if (currentImportTab === 'db') {
        await doImportDb();
      } else {
        await doSync();
      }
    }

    async function doImportDb() {
      const file = $('import-file').files[0];
      if (!file) {
        return toast('请选择 data.db 文件', 'error');
      }

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch(API + '/import', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        });
        const result = await res.json();
        if (!result.success) throw new Error(result.message);
        toast(result.message);
        closeModal('import-modal');
        init();
      } catch (e) {
        toast('导入失败: ' + e.message, 'error');
      }
    }

    async function doSync() {
      const sitemap = $('sync-sitemap').value.trim();
      const file = $('sync-file').files[0];
      const concurrency = parseInt($('sync-concurrency').value) || 3;
      
      if (!sitemap && !file) {
        return toast('请输入 Sitemap URL 或上传 XML 文件', 'error');
      }

      const btn = $('import-btn');
      const progress = $('sync-progress');
      const currentLog = $('progress-current');
      
      btn.disabled = true;
      btn.textContent = '同步中...';
      progress.classList.remove('hidden');

      if (syncEventSource) syncEventSource.close();

      let syncUrl;

      if (file) {
        currentLog.innerHTML = `<div style="color:var(--muted)">正在解析上传的 XML 文件...</div>`;
        
        const formData = new FormData();
        formData.append('file', file);

        try {
          const res = await fetch(API + '/sync/upload', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token },
            body: formData
          });
          const result = await res.json();
          if (!result.success) {
            currentLog.innerHTML = `<div style="color:var(--danger)">${result.message}</div>`;
            btn.disabled = false;
            btn.textContent = '重试';
            return;
          }
          currentLog.innerHTML = `<div style="color:var(--muted)">解析完成，发现 ${result.url_count} 个 URL...</div>`;
          syncUrl = `${API}/sync?sync_id=${encodeURIComponent(result.sync_id)}&concurrency=${concurrency}&token=${encodeURIComponent(token)}`;
        } catch (e) {
          currentLog.innerHTML = `<div style="color:var(--danger)">上传失败: ${e.message}</div>`;
          btn.disabled = false;
          btn.textContent = '重试';
          return;
        }
      } else {
        currentLog.innerHTML = `<div style="color:var(--muted)">正在获取 sitemap...</div>`;
        syncUrl = `${API}/sync?sitemap_url=${encodeURIComponent(sitemap)}&concurrency=${concurrency}&token=${encodeURIComponent(token)}`;
      }

      syncEventSource = new EventSource(syncUrl);

      syncEventSource.addEventListener('progress', (e) => {
        const d = JSON.parse(e.data);
        if (d.total) {
          $('p-total').textContent = d.total;
          $('p-current').textContent = d.current || 0;
          $('p-imported').textContent = d.imported || 0;
          $('p-errors').textContent = d.errors || 0;
          $('progress-fill').style.width = Math.round((d.current / d.total) * 100) + '%';
        }
        if (d.path) {
          const line = d.error 
            ? `<div style="color:var(--danger)">✗ ${d.path}</div>`
            : `<div><span style="color:var(--success)">✓</span> ${d.path} <span style="color:var(--muted)">PV:${d.page_pv}</span></div>`;
          currentLog.innerHTML = line + currentLog.innerHTML;
          while (currentLog.children.length > 20) currentLog.lastChild.remove();
        } else if (d.message) {
          currentLog.innerHTML = `<div style="color:var(--muted)">${d.message}</div>` + currentLog.innerHTML;
        }
      });

      syncEventSource.addEventListener('error', (e) => {
        let msg = '同步失败';
        try { msg = JSON.parse(e.data).message; } catch {}
        currentLog.innerHTML = `<div style="color:var(--danger)">${msg}</div>` + currentLog.innerHTML;
        btn.disabled = false;
        btn.textContent = '重试';
        syncEventSource.close();
      });

      syncEventSource.addEventListener('complete', (e) => {
        const data = JSON.parse(e.data);
        currentLog.innerHTML = `<div style="color:var(--success);font-weight:500">${data.message}</div>` + currentLog.innerHTML;
        $('progress-fill').style.width = '100%';
        toast(data.message);
        syncEventSource.close();
        btn.disabled = false;
        btn.textContent = '完成';
        setTimeout(() => init(), 1000);
      });

      syncEventSource.onerror = () => {
        currentLog.innerHTML = `<div style="color:var(--danger)">连接断开</div>` + currentLog.innerHTML;
        btn.disabled = false;
        btn.textContent = '重试';
        syncEventSource.close();
      };
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeModal('edit-modal');
        closeModal('delete-modal');
        closeModal('rename-modal');
        closeModal('merge-modal');
        closeModal('import-modal');
        closeModal('pages-modal');
        closeModal('edit-page-modal');
      }
    });

    if (token) init();
    else $('auth').classList.remove('hidden');
  </script>
</body>
</html>
